import 'dart:ui';
import 'package:audioplayers/audioplayers.dart';
import 'package:crawlspace_engine/fugue_engine.dart';
import 'package:crawlspace_engine/galaxy.dart';
import 'package:crawlspace_flutter/ui/views/ascii_view.dart';
import 'package:flutter/foundation.dart';
import 'package:flutter/material.dart';
import 'package:url_launcher/url_launcher.dart';
import 'options.dart';

/*
TODO: savefiles, autoscroll tweaks, mobile imgs, organize costs/etc.,
!trade mission generation rnd bug (also investigate amounts)
!missing plugin error for url_launcher
~fix scrolling
~victory handling
distance to homeworld influence,
special planets (all - => lower heat, all +++ => higher heat)
find system feature, center system when clicked?
system notes
system shapes
 */

enum ViewType {normal,textOnly,galaxy}

ViewType currentView = ViewType.normal;

final AudioPlayer fuguePlayer = AudioPlayer();
PlayerOptions fugueOptions = PlayerOptions();

Future<void> main() async {
  WidgetsFlutterBinding.ensureInitialized();
  //await SystemChrome.setPreferredOrientations([DeviceOrientation.landscapeLeft, // Left-side Landscape]);
  runApp(const FugueApp());
}

class FugueApp extends StatelessWidget {
  const FugueApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      scrollBehavior: CustomScrollBehavior(),
      title: 'Space Fugue',
      theme: ThemeData(colorSchemeSeed: Colors.brown), //ThemeData.dark(useMaterial3: true),
      home: const FugueHome(title: 'Space Fugue'),
    );
  }
}

enum ViewState {game,map,options}

class FugueModel extends ChangeNotifier {
  final FugueEngine engine;

  FugueModel(this.engine);

  void notify() => notifyListeners();
}

class FugueHome extends StatefulWidget {
  const FugueHome({super.key, required this.title});
  final String title;

  @override
  State<FugueHome> createState() => _FugueHomeState();
}

class _FugueHomeState extends State<FugueHome> {
  FugueModel? model;
  bool loading = false;
  ViewState view = ViewState.game;

  @override
  void initState() {
    super.initState();
    _loadOptions();
  }
  
  @override
  Widget build(BuildContext context) { //print("Building Main Widget");
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          image: DecorationImage(image: AssetImage("img/splash_land.png"),fit: BoxFit.fill),
        ),
        child: Center(child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: (model?.engine == null)
              ? preGameColumn()
              : gameColumn(),
        ),
      ),
    ));
  }

  List<Widget> gameColumn() {
    return [
      Expanded(child: ListenableBuilder(
        listenable: model!,
        builder: (BuildContext context, Widget? child) => Column(children: [
          if (model!.engine.gameOver) gameOver(),
          //Expanded(child: GalaxyView(fugueModel!,key: ValueKey(fugueModel))),
          Expanded(child: AsciiView(model!.engine,key: ValueKey(model!.engine))),
        ]),
      )),
    ];
  }

  List<Widget> preGameColumn() {
    return [
      const SizedBox(height: 24),
      newGameButton(),
    ];
  }

  Widget newGameButton() {
    return ElevatedButton(
        onPressed: _initGame,
        child: const Text('New Game')
    );
  }

  Widget helpButton({isNewTab = true}) {
    return ElevatedButton(
        onPressed: () => launchUrl(Uri.parse('https://spacefugue.online/help/overview.html'),webOnlyWindowName: isNewTab ? '_blank' : '_self',),
        child: kIsWeb ? const Text('Help') : const Icon(Icons.help)
    );
  }

  Widget optionButton() {
    return ElevatedButton(
      onPressed: _editPlayerOptions,
      child: kIsWeb ? const Text('Options') : const Icon(Icons.settings),
    );
  }

  void _updateSound() { //print("Updating sound... ${fugueOptions.getBool(FugueOption.sound)}");
    if (fugueOptions.getBool(FugueOption.sound)) {
      if (fuguePlayer.state != PlayerState.playing) fuguePlayer.play(AssetSource("audio/tracks/intro1.mp3"));
    } else {
      fuguePlayer.stop();
    }
  }

  void _editPlayerOptions() async {
    if (!context.mounted) return; // Check if widget is still in the tree
    final updated = await showPlayerOptionsDialog(context, fugueOptions);
    if (updated != null) {
      await updated.save();
      if (!context.mounted) return;
      setState(() {
        fugueOptions = updated;
      }); //print("Saved: ${fugueOptions.map}");
      _updateSound();
    }
  }

  void _loadOptions() async {
    setState(() { loading = true; });
    await fugueOptions.load();
    setState(() { loading = false; });
  }

  Widget gameOver() {
    return ColoredBox(color: Colors.black, child:
        Column(children: [
          Text("You were ${model?.engine.result}",
              style: const TextStyle(color: Colors.white)), //const Text("*** SCORE ***"),
          Text("Turns (1 pt each): ${model?.engine.auTick}",
              style: const TextStyle(color: Colors.green)),
          Text("Discovered ${model?.engine.galaxy.discoveredSystems()} systems (2 pts each)",
              style: const TextStyle(color: Colors.blue)),
          Text("Pirates vanquished (3 pts each): ${model?.engine.player.piratesVanquished}",
              style: const TextStyle(color: Colors.grey)),
          Text("Found Star One (500 pts): ${model?.engine.player.starOne}",
              style: const TextStyle(color: Colors.orange)),
          Text("Victory (1000 pts): ${model?.engine.victory}",
              style: const TextStyle(color: Colors.purpleAccent),),
          Text("Score: ${model?.engine.score()}"
              ,style: const TextStyle(color: Colors.white)),
          newGameButton(),
      ]));
  }

  void _initGame() { //_updateSound();
    model = FugueModel(FugueEngine(Galaxy("FooBar"), "Zug"));
    model!.engine.addListener(model!.notify);
    setState(() {
      view = ViewState.game;
    });
  }
}

class CustomScrollBehavior extends MaterialScrollBehavior {
  @override
  Set<PointerDeviceKind> get dragDevices => {
    PointerDeviceKind.touch,
    PointerDeviceKind.mouse,
  };
}
